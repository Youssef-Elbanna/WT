<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Bus Registration (Live Sheet Data)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl; /* Set direction to Right-to-Left for Arabic content */
        }
    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading'; 
        let appInitialized = false;

        // ğŸ›‘ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø·: ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† "Organized Sheet" Ù‡Ùˆ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©)
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTEWQ4H4CmAFvw0-Q6cUnmHkDucek5FP4seP4n65VP4rEsa018o8Ie8vlv41owzhEPTtd8xHKY0mASD/pub?output=csv";

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø«Ø§Ø¨ØªØ©
        const SUPERVISORS = [
            { id: 'ayad_taha', name: 'Ø£ÙŠØ§Ø¯ Ø·Ù‡', line: 'Ø®Ø· Ø§Ù„Ø¨Ø­Ø±' },
            { id: 'mohamed_gamal', name: 'Ù…Ø­Ù…Ø¯ Ø¬Ù…Ø§Ù„', line: 'Ø®Ø· Ø§Ù„Ø¨Ø­Ø±' },
            { id: 'yousef_elbana', name: 'ÙŠÙˆØ³Ù Ø§Ù„Ø¨Ù†Ø§', line: 'Ø®Ø· Ø¬Ù…Ø§Ù„ Ø¹Ø¨Ø¯ Ø§Ù„Ù†Ø§ØµØ±' },
            { id: 'abdelrahman_ehab', name: 'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§ÙŠÙ‡Ø§Ø¨', line: 'Ø®Ø· Ø¬Ù…Ø§Ù„ Ø¹Ø¨Ø¯ Ø§Ù„Ù†Ø§ØµØ±' },
            { id: 'ibrahim_mohamed', name: 'Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø­Ù…Ø¯', line: 'Ø®Ø· Ø§Ù„Ø¹Ø¬Ù…ÙŠ' },
            { id: 'amr', name: 'Ø¹Ù…Ø±Ùˆ', line: 'Ø®Ø· Ø§Ù„Ø³ÙŠÙˆÙ' },
            { id: 'mody', name: 'Ù…ÙˆØ¯ÙŠ', line: 'Ø®Ø· Ø³Ù…ÙˆØ­Ø©' },
            { id: 'abdelrahman_walid', name: 'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† ÙˆÙ„ÙŠØ¯', line: 'Ù…Ø³Ø¦ÙˆÙ„' },
            { id: 'abdelrahman_lord', name: 'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ù„ÙˆØ±Ø¯', line: 'Ù…Ø³Ø¦ÙˆÙ„' },
        ];

        let STUDENTS_DATA = []; 
        
        // DOM Elements
        const supervisorSelect = document.getElementById('supervisor-select');
        const timeSlotSelect = document.getElementById('time-slot');
        const busIdInput = document.getElementById('bus-id');
        const lookupResultDiv = document.getElementById('lookup-result');
        const registerButton = document.getElementById('register-button');
        const recordsContainer = document.getElementById('records-container');
        const recordsSearch = document.getElementById('records-search'); 
        const statusMessage = document.getElementById('status-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const dataStatusDisplay = document.getElementById('data-status-display');
        // ğŸ¯ Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        const recordsCountDisplay = document.getElementById('records-count-display');
        
        let foundStudents = [];

        // Utility function to show messages
        const showStatus = (message, isError = false) => {
            statusMessage.textContent = message;
            statusMessage.className = isError 
                ? 'text-sm text-red-600 bg-red-100 p-3 rounded-lg'
                : 'text-sm text-green-600 bg-green-100 p-3 rounded-lg';
            statusMessage.classList.remove('hidden');
            setTimeout(() => { statusMessage.classList.add('hidden'); }, 5000);
        };

        // Populate Supervisor Dropdown
        const populateSupervisors = () => {
            supervisorSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù --</option>';
            SUPERVISORS.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.name} Ù…Ø´Ø±Ù ${s.line}`;
                supervisorSelect.appendChild(option);
            });
        };
        
        // --- ğŸ¯ Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù CSV Ù…ÙØ­Ø³Ù‘ÙÙ†Ø© ---
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) return []; 
            
            // Ù†ÙØªØ±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:
            // Col1: TimeStamp | Col2: Bus ID | Col3: Student Name | Col4: Line/Route | Col5: Time Slot (E)
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));

                if (values.length >= 5) {
                    const busId = values[1] ? values[1].toString().trim() : ''; // Bus ID (Col B/2)
                    const name = values[2] ? values[2].trim() : ''; // Student Name (Col C/3)
                    // ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙˆÙ‚Øª ÙƒÙ‚ÙŠÙ…Ø© Ù†Ø¸ÙŠÙØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
                    const time = values[4] ? values[4].toString().trim() : ''; // Time Slot (Col E/5)
                    const line = values[3] ? values[3].trim() : ''; // Line (Col D/4)

                    if (busId && name && time) {
                        data.push({
                            busId: busId,
                            name: name,
                            time: time,
                            line: line
                        });
                    }
                }
            }
            return data; 
        };

        // --- Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Google Sheet ---
        const fetchSheetData = async () => {
            dataStatusDisplay.textContent = '... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Google Sheet';
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… `fetch` Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª CSV Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©
                const response = await fetch(SHEET_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                STUDENTS_DATA = parseCSV(csvText); 

                dataStatusDisplay.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${STUDENTS_DATA.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.`;
                dataStatusDisplay.className = 'text-xs text-green-700 font-medium';
                
            } catch (e) {
                console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheet:", e);
                dataStatusDisplay.textContent = "Ø®Ø·Ø£: ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Google Sheet. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†Ø´ÙˆØ±.";
                dataStatusDisplay.className = 'text-xs text-red-700 font-medium';
            }
        };

        // --- CORE APPLICATION LOGIC ---

        const lookupStudents = () => {
            const selectedSupervisorId = supervisorSelect.value;
            const timeSlot = timeSlotSelect.value;
            const searchId = busIdInput.value.trim().toString(); 
            
            if (!selectedSupervisorId) {
                lookupResultDiv.innerHTML = '<p class="text-gray-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø£ÙˆÙ„Ø§Ù‹.</p>';
                registerButton.disabled = true;
                return;
            }

            if (!timeSlot || !searchId) {
                lookupResultDiv.innerHTML = '<p class="text-gray-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨.</p>';
                registerButton.disabled = true;
                return;
            }
            
            if (STUDENTS_DATA.length === 0) {
                 lookupResultDiv.innerHTML = '<p class="text-red-500">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Google Sheet Ø¨Ø¹Ø¯.</p>';
                 registerButton.disabled = true;
                 return;
            }

            // ğŸ›‘ ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… parseFloat Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù„ØªÙˆØ­ÙŠØ¯ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
            const selectedTimeFloat = parseFloat(timeSlot);
            
            foundStudents = STUDENTS_DATA.filter(s => {
                const sheetTimeFloat = parseFloat(s.time);
                
                // Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø´Ø±ÙŠ
                const matchesTime = sheetTimeFloat === selectedTimeFloat;
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ Bus ID (Ù…Ø·Ø§Ø¨Ù‚Ø© ØªØ§Ù…Ø©) Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (ØºÙŠØ± Ø­Ø³Ø§Ø³ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù)
                const matchesId = s.busId === searchId;
                const matchesName = s.name.toLowerCase().includes(searchId.toLowerCase());
                
                return matchesTime && (matchesId || matchesName);
            });

            renderLookupResults(foundStudents);
        };

        const renderLookupResults = (students) => {
            if (students.length === 0) {
                lookupResultDiv.innerHTML = `
                    <p class="text-red-500 font-semibold p-2 border-2 border-red-300 rounded-lg">
                        Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚ÙˆÙ† Ù„Ù€ ("${busIdInput.value}") ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯.
                    </p>
                `;
                registerButton.disabled = true;
                return;
            }

            const studentListHtml = students.map(s => `
                <div class="bg-gray-100 p-3 my-2 rounded-lg flex justify-between items-center border-r-4 border-indigo-500">
                    <div>
                        <p class="text-lg font-bold text-gray-800">${s.name}</p>
                        <p class="text-sm text-gray-600">
                            Ø§Ù„Ø®Ø·: ${s.line} | Ø¨Ø§Øµ: ${s.busId} | ÙˆÙ‚Øª: ${s.time} Ù…
                        </p>
                    </div>
                    <div class="text-xs text-indigo-700 font-medium">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„</div>
                </div>
            `).join('');

            lookupResultDiv.innerHTML = `
                <h3 class="text-md font-semibold mb-2">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ÙˆÙ† (${students.length}):</h3>
                ${studentListHtml}
            `;
            registerButton.disabled = false;
        };
        
        const registerStudent = async () => {
            if (!db || !userId || foundStudents.length === 0 || !supervisorSelect.value) {
                showStatus('Ø®Ø·Ø£: Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±Ù ÙˆØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨.', true);
                return;
            }

            const selectedSupervisor = SUPERVISORS.find(s => s.id === supervisorSelect.value);
            const logCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/registrations`);
            
            // ğŸ¯ ØªÙ… Ø¬Ù„Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§ØªØ³Ø§Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
            const selectedTimeSlotValue = timeSlotSelect.value; 
            
            let successCount = 0;
            let skipCount = 0;

            for (const student of foundStudents) {
                try {
                    // --- ğŸ¯ Ù…Ù†Ø·Ù‚ Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙƒØ±Ø± (StudentName + TimeSlot + BusID) ---
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
                    const q = query(
                        logCollectionRef, 
                        where("studentName", "==", student.name),
                        where("timeSlot", "==", selectedTimeSlotValue),
                        where("busId", "==", student.busId)
                    );
                    
                    const existingDocs = await getDocs(q);

                    if (!existingDocs.empty) {
                        skipCount++;
                        continue; 
                    }
                    // --- Ù†Ù‡Ø§ÙŠØ© Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ---

                    const record = {
                        busId: student.busId,
                        studentName: student.name,
                        // ğŸ›‘ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ±Ø©
                        timeSlot: selectedTimeSlotValue, 
                        
                        // ğŸ¯ NEW: Save the student's line/route information
                        line: student.line, 
                        
                        supervisorFirebaseId: userId, 
                        supervisorId: selectedSupervisor.id, 
                        supervisorName: selectedSupervisor.name, 
                        
                        timestamp: serverTimestamp()
                    };

                    await addDoc(logCollectionRef, record);
                    successCount++;

                } catch (error) {
                    console.error("Error writing document for student ", student.name, error);
                    showStatus(`Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ ${student.name}: ${error.message}`, true);
                    return; 
                }
            }

            // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            let message = `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${successCount} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø¨Ø§Øµ ${busIdInput.value} Ø¨ÙˆØ§Ø³Ø·Ø© ${selectedSupervisor.name}.`;
            if (skipCount > 0) {
                message += ` (${skipCount} Ø·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ØªÙ… ØªØ®Ø·ÙŠÙ‡Ù…).`;
            }
            showStatus(message, successCount === 0);
            
            busIdInput.value = '';
            lookupStudents(); 
            loadRegistrations(); 
        };

        const deleteRecord = async (docId) => {
            if (!db || !userId) {
                showStatus('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', true);
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/registrations`, docId);
                await deleteDoc(docRef);
                showStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.');
            } catch (error) {
                console.error("Error deleting document: ", error);
                showStatus(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ${error.message}`, true);
            }
        };

        // ğŸ¯ NEW: Function to render the line breakdown summary
        const renderLineSummary = (lineCounts, timeSlot) => {
            const container = document.getElementById('records-summary-container');
            if (!container) return;

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„ÙˆÙ‚Øª
            const timeText = timeSlotSelect.options[timeSlotSelect.selectedIndex].textContent;
            
            let summaryHtml = `<h3 class="text-md font-bold text-gray-800 mb-3">Ù…Ù„Ø®Øµ Ø®Ø·ÙˆØ· Ø§Ù„Ø¨Ø§ØµØ§Øª Ù„ÙˆÙ‚Øª ${timeText}:</h3>`;

            if (Object.keys(lineCounts).length === 0) {
                 container.innerHTML = summaryHtml + '<p class="text-sm text-gray-500 mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ÙˆØ· Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª.</p>';
                 return;
            }

            const total = Object.values(lineCounts).reduce((sum, count) => sum + count, 0);

            // ÙØ±Ø² Ø§Ù„Ø®Ø·ÙˆØ· ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯
            const sortedLines = Object.entries(lineCounts).sort(([, a], [, b]) => b - a);

            summaryHtml += '<div class="space-y-3">';
            sortedLines.forEach(([line, count]) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
                summaryHtml += `
                    <div>
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="font-medium text-gray-700">${line}</span>
                            <span class="font-semibold text-indigo-600">${count} Ø·Ø§Ù„Ø¨ (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="bg-indigo-500 h-1.5 rounded-full transition-all duration-500 ease-out" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            summaryHtml += '</div>';
            
            container.innerHTML = summaryHtml;
        };


        const loadRegistrations = () => {
            if (!db || !userId) {
                recordsContainer.innerHTML = '<p class="text-gray-500">ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø´Ø±Ø§Ù...</p>';
                // ğŸ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ØµÙØ±
                recordsCountDisplay.textContent = ' (0 Ø³Ø¬Ù„)';
                return;
            }

            const selectedTimeSlot = timeSlotSelect.value;
            const searchTerm = recordsSearch.value.trim().toLowerCase();

            if (!selectedTimeSlot) {
                 recordsContainer.innerHTML = '<p class="text-gray-500 p-4 bg-white rounded-lg border">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡.</p>';
                 // ğŸ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ØµÙØ±
                 recordsCountDisplay.textContent = ' (0 Ø³Ø¬Ù„)';
                 document.getElementById('records-summary-container').innerHTML = '<p class="text-sm text-gray-500">Ù…Ù„Ø®Øµ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ· Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§.</p>';
                 return;
            }

            const logCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/registrations`);
            
            // Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Firestore Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆÙ‚Øª ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            let q = query(
                logCollectionRef, 
                where("timeSlot", "==", selectedTimeSlot)
            );
            
            // Listen for real-time updates
            onSnapshot(q, (snapshot) => {
                
                // ğŸ¯ ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª (timestamp)
                let sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().timestamp ? a.data().timestamp.toDate().getTime() : 0;
                    const timeB = b.data().timestamp ? b.data().timestamp.toDate().getTime() : 0;
                    // ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
                    return timeB - timeA; 
                });

                // Search: Local filtering by search term (name or bus ID)
                let filteredDocs = sortedDocs;
                if (searchTerm) {
                    filteredDocs = sortedDocs.filter(doc => {
                        const data = doc.data();
                        return (data.studentName && data.studentName.toLowerCase().includes(searchTerm)) ||
                               (data.busId && data.busId.toLowerCase().includes(searchTerm));
                    });
                }
                
                // ğŸ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                recordsCountDisplay.textContent = ` (${filteredDocs.length} Ø³Ø¬Ù„)`;
                
                // ğŸ¯ NEW: Calculate and render line breakdown summary
                const lineCounts = {};
                filteredDocs.forEach(doc => {
                    const data = doc.data();
                    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø§ØµÙŠØ© line ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¬Ù„
                    const line = data.line || 'Ø®Ø· ØºÙŠØ± Ù…Ø³Ø¬Ù„ (Ù‚Ø¯ÙŠÙ…)'; 
                    lineCounts[line] = (lineCounts[line] || 0) + 1;
                });
                renderLineSummary(lineCounts, selectedTimeSlot);

                let recordsHtml = '';
                if (filteredDocs.length === 0) {
                    recordsHtml = '<p class="text-gray-500 p-4 bg-white rounded-lg border">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø±ÙƒÙˆØ¨ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª/Ø§Ù„Ø¨Ø­Ø«.</p>';
                } else {
                    recordsHtml = filteredDocs.map(doc => {
                        const data = doc.data();
                        const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'}) : '...';
                        const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('ar-EG') : '...';
                        
                        return `
                            <div class="bg-white p-4 my-2 rounded-lg shadow-sm flex justify-between items-center transition hover:shadow-md">
                                <div>
                                    <p class="text-md font-bold text-indigo-700">${data.studentName}</p>
                                    <p class="text-sm text-gray-700">Ø¨Ø§Øµ: ${data.busId} | Ø®Ø·: ${data.line || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'} | ÙˆÙ‚Øª: ${data.timeSlot} Ù…</p>
                                    <p class="text-xs text-gray-500 mt-1">ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø©: ${data.supervisorName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} @ ${date} ${time}</p>
                                </div>
                                <button onclick="window.deleteRecord('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full text-xs transition duration-150">
                                    Ø­Ø°Ù
                                </button>
                            </div>
                        `;
                    }).join('');
                }
                recordsContainer.innerHTML = recordsHtml;
            }, (error) => {
                console.error("Error loading records: ", error);
                recordsContainer.innerHTML = `<p class="text-red-500">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${error.message}</p>`;
                // ğŸ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ØµÙØ± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                recordsCountDisplay.textContent = ' (Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„)';
            });
        };


        // --- INITIALIZATION AND BINDING ---

        const initializeAppAndAuth = async () => {
            try {
                populateSupervisors(); 
                
                // ğŸ›‘ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Google Sheet Ø£ÙˆÙ„Ø§Ù‹
                await fetchSheetData();

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // For debugging:
                setLogLevel('error'); 

                // 1. Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `Ù…ÙØ¹Ø±Ù‘Ù Ø§Ù„Ù†Ø¸Ø§Ù… (UID): ${userId}`;
                        appInitialized = true;
                    } else {
                        userId = crypto.randomUUID(); 
                        userIdDisplay.textContent = `Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©`;
                    }
                    
                    // Show UI after initialization
                    document.getElementById('app-loading').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                });

            } catch (error) {
                console.error("Firebase Initialization Error: ", error);
                showStatus(`Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: ${error.message}`, true);
            }
        };

        // Bind functions to window scope for use in inline HTML 
        window.deleteRecord = deleteRecord;
        
        // Setup event listeners
        supervisorSelect.addEventListener('change', lookupStudents); 
        timeSlotSelect.addEventListener('change', () => { 
            lookupStudents(); 
            loadRegistrations(); 
        });
        busIdInput.addEventListener('input', lookupStudents);
        registerButton.addEventListener('click', registerStudent);
        recordsSearch.addEventListener('input', loadRegistrations); 
        
        // Start the application
        initializeAppAndAuth();
    </script>
</head>
<body class="bg-gray-50 p-4 sm:p-8 min-h-screen">
    
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-indigo-800 mb-6 border-b pb-2">Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø±ÙƒÙˆØ¨ Ø§Ù„Ø¨Ø§ØµØ§Øª</h1>

        <div id="app-loading" class="text-center p-10 bg-white rounded-xl shadow-lg">
            <p class="text-indigo-500 font-semibold text-lg">... ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ©</p>
        </div>

        <div id="app-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            
            <!-- Column 1 & 2: Registration Panel -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-xl space-y-6">
                
                <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">1. ØªØ³Ø¬ÙŠÙ„ Ø±ÙƒÙˆØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>

                <!-- Supervisor Input -->
                <div class="mb-4">
                    <label for="supervisor-select" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                    <select id="supervisor-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>

                <!-- Time & Bus ID Fields -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="time-slot" class="block text-sm font-medium text-gray-700 mb-1">ÙˆÙ‚Øª Ø§Ù„Ø±Ø­Ù„Ø©</label>
                        <select id="time-slot" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            <option value="">-- Ø§Ø®ØªØ± ÙˆÙ‚ØªØ§Ù‹ --</option>
                            <option value="12.3">12:30 Ù…</option>
                            <option value="1.3">01:30 Ù…</option>
                            <option value="4.0">04:00 Ù…</option>
                        </select>
                    </div>
                    <div>
                        <label for="bus-id" class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                        <input type="text" id="bus-id" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù…..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-left" dir="ltr" />
                    </div>
                </div>
                <p id="data-status-display" class="text-xs text-gray-500"></p>

                <div id="status-message" class="hidden my-4"></div>

                <!-- Lookup Results -->
                <div id="lookup-result" class="min-h-[100px] p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-gray-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Øµ ÙˆØ§Ù„ÙˆÙ‚Øª.</p>
                </div>

                <!-- Register Button -->
                <button id="register-button" disabled class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01] disabled:bg-indigo-400">
                    ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø§Øµ (Ø±ÙƒØ¨ Ø§Ù„Ø¨Ø§Øµ)
                </button>

            </div>

            <!-- Column 3: Supervisor Records -->
            <div class="lg:col-span-1 bg-gray-100 p-6 rounded-xl shadow-inner space-y-4">
                
                <!-- ğŸ¯ ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
                <h2 class="text-xl font-bold text-gray-700 border-b pb-3 flex justify-between items-center">
                    <span>2. Ø³Ø¬Ù„Ø§ØªÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
                    <span id="records-count-display" class="text-sm font-semibold text-indigo-500"> (0 Ø³Ø¬Ù„)</span>
                </h2>
                
                <p id="user-id-display" class="text-xs text-gray-600 mb-4 bg-white p-2 rounded-lg"></p>

                <!-- ğŸ¯ NEW: Summary Container -->
                <div id="records-summary-container" class="space-y-2 mb-6 p-4 bg-white rounded-xl shadow-md border-b-4 border-indigo-400">
                    <p class="text-sm text-gray-500">Ù…Ù„Ø®Øµ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ· Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§.</p>
                </div>

                <!-- Search Input -->
                <div class="mb-4">
                    <input type="text" id="records-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" />
                </div>

                <!-- Records List -->
                <div id="records-container" class="space-y-3">
                    <p class="text-gray-500">... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</p>
                </div>
            </div>

        </div>
    </div>
</body>
</html>